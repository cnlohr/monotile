<html>
<head>
<style>
html,
body {
  height: 100%;
  margin: 0;
}

.maincanvas {
    position: absolute;
    left: 0px;
	top: 0px;
    z-index: -5;
}

</style>
<script>
var canvasCtx;
var canvas;
var maindiv;

function getCookie(cname) {
	let name = cname + "=";
	let decodedCookie = decodeURIComponent(document.cookie);
	let ca = decodedCookie.split(';');
	for(let i = 0; i <ca.length; i++) {
		let c = ca[i];
		while (c.charAt(0) == ' ') {
			c = c.substring(1);
		}
		if (c.indexOf(name) == 0) {
			return c.substring(name.length, c.length);
		}
	}
	return "";
}

function frame()
{
    canvas.width = maindiv.clientWidth;
    canvas.height = maindiv.clientHeight;

	canvasCtx.fillStyle = "blue";
	canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

	canvasCtx.fillRect(25, 25, 1000, 1000);
	canvasCtx.clearRect(45, 45, 60, 60);
	canvasCtx.strokeRect(50, 50, 50, 50);

	window.requestAnimationFrame( frame );
}


const consume = responseReader => {
    return responseReader.read().then(result => {
		if( result.value )
		{
			// result.value = uint8array.
			console.log( result.value );
		}
		else
		{
			console.log( result );
		}
		if (result.done) { return; }

		// do something with the current chunk
		const chunk = result.value;
		return consume(responseReader);
    });
}

function sysload()
{
	let loginelem = document.getElementById( "loginprops" );
	let userlogin = getCookie("userlogin");
	if( userlogin === "" || userlogin == "" )
	{
		console.log( "No username found" );
		let loginurl = "https://github.com/login/oauth/authorize?client_id=4a55dbe35237fa207491&state=" + Math.random();
		loginelem.innerHTML = '<a href="' + loginurl + '">Github Auth</a>';
	}
	else
	{
		let useravatar = getCookie("useravatar");
		loginelem.innerHTML = 
			'<table><tr><td><img src="' + getCookie("useravatar") + '" width=50></td><td>' +
			'Welcome,<br>' + userlogin + '<br><a href=logout.cgi><font size=-3>Logout</font></a>' +
			'</td></tr></table>';
	}

	maindiv = document.getElementById("maindiv");
	canvas = document.getElementById("maincanvas");
	canvasCtx = canvas.getContext("2d");

	window.requestAnimationFrame( frame );

	fetch("stream.cgi").then(response => {
		return consume(response.body.getReader());
	}).catch(console.log.bind(console));
}
</script>
<body onload=sysload()>

<table border=1 style="height:100%;width:100%; position: absolute; top: 0; bottom: 0; left: 0; right: 0;border:1px solid">
<tr><td>
<div id=loginprops>
identity
</div>
</td>
<td width=100%><div id=hud>hud</div>
</td></tr>
<tr><td height=100% colspan=2 VALIGN=TOP>

<div style="position:relative;height:100%" id="maindiv">

<form action="https://cnvr.io/monotile/plot.cgi" method="post">
<input type="hidden" name="test" value="value" >
<input type="hidden" name="test1" value="value1" >
<input type="text" name="cx">
<input type="text" name="cy">
<input type="text" name="color">
<input type="submit" value="Send Request" />
</form>

<CANVAS id=maincanvas class=maincanvas>
</CANVAS>
</div>

</td></tr>
</table>

</body>
</html>
